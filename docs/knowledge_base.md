# База знаний (Codex)
# docs/knowledge_base.md
# ВАЖНО: этот файл — единый источник “как делаем проект”. Следовать ему обязательно.

Версия: 1.0
Язык: русский
Кодировка: UTF-8 с BOM (обязательно)

- Всегда отвечать на русском языке.
- Документацию и инструкции с русским текстом сохранять в UTF-8 с BOM, не использовать CP1251; проверять кодировку, чтобы не появлялись вопросительные знаки вместо русских букв.
- Не изменять и не коммитить файл `notouch.txt`.
- Если что-то нельзя сделать автоматически — выдавать пошаговые инструкции.
- Все изменения коммитить в git. Убедится что заливаешь в проект p2
- Git: не коммитить `notouch.txt`, пушить рабочие изменения проекта.
- Не коммитить/не пушить:
  - notouch.txt (никогда не трогать)
  - секреты, ключи, токены, приватные конфиги SDK
  - .env* (кроме .env.example)
- Убедиться, что .gitignore покрывает перечисленное.
- Не добавлять “тяжёлые”/лишние бинарники в репо без необходимости.
- Обязательны всё покрывать тестами:
  - Unit tests: логика конфигов, PRNG, выбор апгрейдов, директор
  - Integration tests: сборка RuntimeConfig, генерация волн без рендера, сохранения
  - E2E tests: запуск игры, туториал, flip, recycler, апгрейд, results, daily
- CI обязательно запускает все ключевые проверки.

РОЛЬ: Ты — AI агент-разработчик. Работай как инженер C++ под Windows 11, ориентируйся на скорость и качество результата.

ЯЗЫК И КОДИРОВКА (ОБЯЗАТЕЛЬНО):
1) Всегда отвечай на русском языке.
2) Документацию/инструкции с русским текстом сохраняй в UTF-8 с BOM (НЕ CP1251). Всегда проверяй кодировку, чтобы не появлялись "????" вместо русских букв.
3) Файл `notouch.txt` не изменять и не коммитить НИКОГДА.

GIT/ПРОЕКТ (ОБЯЗАТЕЛЬНО):
1) Все изменения коммить в git. Убедись, что пушишь в проект `p2`.
2) Не коммитить/не пушить:
   - notouch.txt (никогда не трогать)
   - секреты/ключи/токены/приватные SDK-конфиги
   - .env* (кроме .env.example)
3) Убедись, что .gitignore покрывает перечисленное.
4) Не добавляй “тяжёлые”/лишние бинарники в репо без необходимости.
5) Если что-то нельзя сделать автоматически — выдай пошаговые инструкции.

ТЕСТЫ И CI (ОБЯЗАТЕЛЬНО):
1) Обязательны тесты:
   - Unit tests: логика конфигов, PRNG, выбор апгрейдов, директор
   - Integration tests: сборка RuntimeConfig, генерация волн без рендера, сохранения
   - E2E tests: запуск игры, туториал, flip, recycler, апгрейд, results, daily
2) CI обязательно запускает все ключевые проверки.

ЛОГИ (ОБЯЗАТЕЛЬНО):
- Все логи писать в текстовый файл с названием `ГГГГ-ММ-ДД.log` (например, `2026-01-09.log`).
- Логи должны фиксировать: старт, выбранный путь, созданные папки, список дисплеев, созданные файлы, ошибки (с кодами), время выполнения ключевых этапов.

КОММЕНТАРИИ В КОДЕ И ДОКУМЕНТАЦИЯ РАЗРАБОТКИ (ОБЯЗАТЕЛЬНО):
1) Код должен содержать комментарии:
   - Краткие поясняющие комментарии к нетривиальным местам (почему так сделано, что оптимизируется, какие ограничения WinAPI).
   - Для публичных функций/классов — комментарии уровня “что делает / входы / выходы / ошибки”.
   - Для важных алгоритмических/производительных решений — комментарий “обоснование” (1–3 строки).
   - Не засорять очевидные строки “комментами ради комментов”.
2) Вести документацию разработки (dev-дневник) в репозитории:
   - Файл: `docs/dev_log.md` (или аналогичный в `docs/`), на русском, UTF-8 BOM.
   - Формат: записи по датам (YYYY-MM-DD), что сделано, какие решения приняты, какие проблемы/риски, что дальше.
   - Фиксировать ключевые технические решения: почему выбран Desktop Duplication, как устроен fallback на GDI, как настраивается качество JPEG.
3) Вести чек-лист готовности (обязательно и постоянно обновлять):
   - Файл: `docs/checklist.md`, на русском, UTF-8 BOM.
   - Чек-лист должен иметь разделы:
     - ✅ Сделано
     - 🟡 В процессе
     - ⛔ Не сделано
     - 🧪 Тесты/CI (что покрыто, что нет)
     - 📌 Известные ограничения/техдолг
   - После каждого значимого шага (или коммита) обновлять чек-лист так, чтобы было видно прогресс.
4) README для пользователя и DEV-доки для разработчика должны быть раздельно:
   - `README.md` — как собрать/запустить/примеры.
   - `docs/` — решения, чек-лист, dev_log, ограничения.

================================================================================
ЗАДАЧА: C++ ПРОГРАММА ДЛЯ WINDOWS 11 — СКРИНШОТ ВСЕХ ДИСПЛЕЕВ В JPG С МАКС. СЖАТИЕМ
================================================================================

ЦЕЛЬ:
Разработать на C++ (Windows 11) консольную утилиту/программу, которая делает скриншот(ы) экрана:
- Если дисплеев несколько — делает скриншот КАЖДОГО дисплея (отдельные файлы).
- Сохраняет в JPG с максимально возможным сжатием.
- Оптимизирована по скорости (приоритет №1).

ВХОДНЫЕ ПАРАМЕТРЫ/ИНТЕРФЕЙС:
- Программа должна принимать путь к корневой папке для сохранения (например, аргумент командной строки `--out "D:\Screens"`).
- Папка должна выбираться/использоваться как “заданная папка”.
- Если нужных подпапок нет — создать. Если есть — использовать.

ПОЛУЧЕНИЕ ИМЕН:
1) Имя компьютера: получить через WinAPI (Unicode), например GetComputerNameW.
2) Имя пользователя: получить через WinAPI (Unicode), например GetUserNameW.
3) Сформировать `PC_USER` = `ИмяКомпьютера + "_" + ИмяПользователя`.

САНИТИЗАЦИЯ ИМЁН (ОБЯЗАТЕЛЬНО):
- Удалять запрещённые для Windows файлов/папок символы: \ / : * ? " < > | и управляющие символы.
- Также корректно обрабатывать пробелы/точки на конце имени (Windows не любит trailing dot/space) — удалять.
- Если после очистки строка пустая — заменить на безопасный плейсхолдер (например, "UNKNOWN").
- Везде использовать wide-char пути (UTF-16) и корректное создание директорий.

ИЕРАРХИЯ ПАПОК (ОБЯЗАТЕЛЬНО):
Внутри указанной корневой папки структура должна быть строго такой:
1) `<root>\<PC_USER>\`
2) `<root>\<PC_USER>\<YYYY-MM>\`
3) `<root>\<PC_USER>\<YYYY-MM>\<YYYY-MM-DD>\`

ИМЕНА ФАЙЛОВ СКРИНШОТОВ (ОБЯЗАТЕЛЬНО):
Формат имени JPG:
`ИмяКомпьютера + "_" + ИмяПользователя + "_" + ГГГГ-ММ-ДД + "_" + ЧЧ-ММ-СС + ".jpg"`
Если несколько дисплеев — добавить номер дисплея в конец перед расширением:
`..._DisplayNN.jpg` (NN = 01, 02, 03... в порядке перечисления дисплеев/outputs).

ФОРМАТ И СЖАТИЕ JPG (ОБЯЗАТЕЛЬНО):
- JPG с максимальным сжатием (минимальное качество, насколько позволяет кодек).
- Использовать Windows Imaging Component (WIC) или другой стандартный для Windows механизм без лишних зависимостей.
- Явно выставлять параметр качества JPEG на минимально разумный уровень (например, quality ~ 1–10 или WIC ImageQuality ~ 0.01–0.10).
- При этом сохранять корректный JPG, совместимый с обычными просмотрщиками.

ЗАХВАТ ЭКРАНА (МУЛЬТИМОНИТОР) — СКОРОСТЬ КРИТИЧНА:
- Требование: максимально быстро.
- Предпочтительная реализация: Desktop Duplication API (DXGI / Direct3D11) для каждого output:
  - Инициализировать D3D11 device.
  - Для каждого IDXGIOutput(1) создать IDXGIOutputDuplication и получить кадр.
  - Скопировать в staging texture и извлечь байты (BGRA).
  - Передать в WIC encoder (конвертация в нужный формат, например 24bpp BGR).
- Обязателен fallback (если Desktop Duplication недоступен/ошибка) на GDI BitBlt:
  - EnumDisplayMonitors + GetMonitorInfo
  - CreateCompatibleDC/Bitmap + BitBlt для области монитора
  - Далее сохранить через WIC.
- Важно: захват каждого дисплея должен соответствовать его реальному разрешению (не растягивать).
- Корректно обрабатывать scaling/DPI: сделать так, чтобы итоговый скрин был пиксель-в-пиксель (по возможности). Если сложно — задокументировать решение и ограничения.

ОПТИМИЗАЦИЯ ПО СКОРОСТИ (ОБЯЗАТЕЛЬНО):
- Минимизировать копирования памяти.
- Для много-мониторных конфигураций захватать мониторы последовательно, но код должен быть готов к параллелизации (например, очередь задач: capture->encode).
- Замерять и логировать время этапов (enumeration, capture per display, encode per display, total).
- Избегать лишних аллокаций: переиспользовать буферы, где возможно.
- Все операции с диском и созданием папок — один раз на запуск.

ОБРАБОТКА ОШИБОК И ПОВЕДЕНИЕ:
- Если корневой путь невалиден/нет доступа — вывести понятную ошибку и код возврата != 0.
- Если не удалось снять один из дисплеев — продолжить для остальных, но итоговый код возврата должен отражать частичный провал (например, != 0) и в логах указать, какой дисплей упал и почему.
- Все сообщения/логи — на русском языке.

СТРУКТУРА РЕПО/СБОРКА:
- Сборка через CMake (Visual Studio 2022 toolchain) или через стандартный VS project — выбери то, что лучше вписывается в `p2`, но не усложняй.
- Не добавляй сторонние “тяжёлые” библиотеки. Используй WinAPI/D3D11/DXGI/WIC.
- Код должен быть чистый, с разделением на модули:
  - path_utils (sanitize, build paths)
  - time_utils (форматы дат/времени)
  - display_enum (получение списка дисплеев)
  - capture_dxgi / capture_gdi (захват)
  - encode_wic (сохранение jpg)
  - logging (лог-файл)

ТЕСТИРОВАНИЕ (ПРИМЕНИТЬ К ЭТОЙ ЗАДАЧЕ МАКСИМАЛЬНО, НЕ ЛОМАЯ ОБЩИЕ ПРАВИЛА):
- Добавить unit-тесты на:
  - sanitize имён (запрещённые символы, trailing dot/space, пустая строка)
  - генерацию путей и имён файлов (форматы YYYY-MM, YYYY-MM-DD, HH-MM-SS)
- Integration тесты:
  - сборка конфигурации пути вывода
  - создание директорий в temp-папке
  - “сухой прогон” пайплайна сохранения (без реального захвата, через тестовый буфер изображения)
- Если полноценные E2E для скриншота на CI невозможны — сделать максимально близкую имитацию/смоук-тест и документировать ограничения, но CI всё равно должен запускать ключевые проверки.

ВЫХОДНЫЕ АРТЕФАКТЫ:
1) Исходники C++ с реализацией.
2) CMake/проектные файлы для сборки.
3) Тесты + настройки запуска в CI.
4) Документация:
   - `README.md` (пользователь)
   - `docs/dev_log.md` (дневник разработки)
   - `docs/checklist.md` (чек-лист готовности)
   Все на русском, в UTF-8 BOM.

ПРОЦЕСС РАБОТЫ (ОБЯЗАТЕЛЬНО):
- Делай небольшие атомарные коммиты с понятными сообщениями.
- После ключевых шагов обновляй `docs/dev_log.md` и `docs/checklist.md`.
- Проверяй, что `notouch.txt` не изменён и не попадает в коммит.
- Перед пушем прогоняй тесты локально (или опиши шаги, если автоматом нельзя).
- Пушь только рабочие изменения проекта в `p2`.

КРИТИЧЕСКИЕ ТРЕБОВАНИЯ, КОТОРЫЕ НЕЛЬЗЯ НАРУШИТЬ:
- Скорость: приоритет №1.
- Мульти-монитор: скрин КАЖДОГО дисплея.
- JPG с максимальным сжатием.
- Строгая иерархия папок и формат имён.
- Лог-файл `YYYY-MM-DD.log`.
- Комментарии в коде + dev_log + чек-лист (постоянно вести).
- Русский язык, UTF-8 BOM для русской документации.
- `notouch.txt` не трогать и не коммитить.
